<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="YUCHILL">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f1f5f9; color: #0f172a; }
        .tab-active { background: #4f46e5 !important; color: white !important; }
        .void-line { text-decoration: line-through; opacity: 0.15; filter: grayscale(1); pointer-events: none; }
        input, select { border: 1px solid #cbd5e1 !important; font-weight: 800; }
        .log-title { font-weight: 900; font-size: 16px; }
        .log-detail { font-weight: 800; font-size: 14px; line-height: 1.6; color: #334155; }
    </style>
</head>
<body class="pb-10">

    <nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="font-black text-2xl italic">YUCHILL <span class="text-indigo-600">v71</span></h1>
            <div class="flex bg-slate-200 rounded-2xl p-1">
                <button onclick="switchTab('main')" id="tab-main" class="tab-active px-8 py-2 rounded-xl font-black">æ¥­å‹™è™•ç†</button>
                <button onclick="switchTab('report')" id="tab-report" class="px-8 py-2 rounded-xl font-black text-slate-500">åˆ©æ½¤å ±è¡¨</button>
            </div>
            <button onclick="exportData()" class="bg-white border px-4 py-2 rounded-xl font-bold text-sm shadow-sm">å‚™ä»½è³‡æ–™</button>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 mt-6">
        <div id="page-main">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-5">
                    <form id="main-form" class="bg-white p-8 rounded-[2.5rem] shadow-2xl border border-white space-y-6">
                        <div class="flex bg-slate-100 rounded-2xl p-1 font-black">
                            <button type="button" onclick="setMode('sell')" id="m-sell" class="flex-1 py-4 rounded-xl bg-white shadow-sm text-indigo-600">éŠ·å”® / æœå‹™</button>
                            <button type="button" onclick="setMode('buy')" id="m-buy" class="flex-1 py-4 rounded-xl text-slate-400">æ¡è³¼ / é€²è²¨</button>
                        </div>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="text-xs font-black text-slate-400 ml-1">äº¤æ˜“æ—¥æœŸ</label>
                                <input type="date" id="f-date" onchange="autoRefreshBarcode()" class="w-full p-4 rounded-2xl bg-slate-50 border outline-none">
                            </div>
                            <div id="buy-qty-area" class="hidden w-32">
                                <label class="text-xs font-black text-orange-500 ml-1">é€²è²¨æ•¸é‡</label>
                                <input type="number" id="f-qty" value="1" min="1" class="w-full bg-orange-50 p-4 rounded-2xl font-black text-orange-600 text-center border">
                            </div>
                        </div>
                        <div class="p-6 bg-indigo-50/50 rounded-[2rem] border border-indigo-100 space-y-4">
                            <div class="flex gap-2">
                                <input type="text" id="f-barcode" oninput="handleBarcodeInput(this.value)" placeholder="æ¢ç¢¼å€åŸŸ" class="flex-1 p-4 rounded-xl font-black text-indigo-700 text-center uppercase bg-white border">
                                <button type="button" onclick="generateNextBarcode()" class="bg-white px-4 rounded-xl text-indigo-500 border border-indigo-200 shadow-sm">ğŸ”„</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="f-car-type" onchange="autoRefreshBarcode()" class="p-4 rounded-xl font-black bg-white border">
                                    <option value="">- è»Šçµ„ -</option>
                                    <option data-code="J">Jå¯„è³£æ¬¾(8)</option><option data-code="J">Jå¯„è³£æ¬¾/è»Š</option><option data-code="G">Gé’æ˜¥ç‰ˆ(8)</option>
                                    <option data-code="Q">Qç‰¹æƒ ç‰ˆ</option><option data-code="W">Wé«˜é…ç‰ˆ</option><option data-code="Q">Qç‰¹æƒ Xé˜²ç›œ</option>
                                    <option data-code="S">ç¶­ä¿®æœå‹™</option>
                                </select>
                                <select id="f-color" onchange="autoRefreshBarcode()" class="p-4 rounded-xl font-black bg-white border">
                                    <option value="">- é¡è‰² -</option>
                                    <option value="1">é»‘</option><option value="2">ç™½</option><option value="3">ç²‰</option><option value="4">è—</option><option value="5">ç´«</option><option value="6">ç´…</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="f-vin" placeholder="è»Šæ¶è™Ÿ" class="p-4 rounded-xl font-bold bg-white text-sm border">
                                <input type="text" id="f-motor" placeholder="é›»æ©Ÿè™Ÿ" class="p-4 rounded-xl font-bold bg-white text-sm border">
                            </div>
                            <select id="f-batt" class="w-full p-4 rounded-xl font-black bg-white border">
                                <option value="">- é›»æ±  -</option><option>8AH</option><option>20AH</option><option>30AH</option>
                            </select>
                        </div>
                        <div class="p-6 bg-slate-50 rounded-[2rem] border border-slate-200 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <select class="f-ps p-3 rounded-xl font-bold bg-white text-sm border"><option value="">+ é…ä»¶ 1</option><option>å…’ç«¥åº§æ¤…</option><option>å®šæ™‚å™¨</option><option>æ°´æ¯æ¶</option><option>é›™æ¯æ‰‹æ©Ÿæ¶</option><option>å¾Œç…§é¡2é•·</option><option>å¾Œåº§é èƒŒ</option><option>å¾Œè…³è¸/å¡‘</option><option>å¾Œè…³è¸/éµ</option></select>
                                <select class="f-ps p-3 rounded-xl font-bold bg-white text-sm border"><option value="">+ é…ä»¶ 2</option><option>å…’ç«¥åº§æ¤…</option><option>å®šæ™‚å™¨</option><option>æ°´æ¯æ¶</option><option>é›™æ¯æ‰‹æ©Ÿæ¶</option><option>å¾Œç…§é¡2é•·</option><option>å¾Œåº§é èƒŒ</option><option>å¾Œè…³è¸/å¡‘</option><option>å¾Œè…³è¸/éµ</option></select>
                                <select class="f-ps p-3 rounded-xl font-bold bg-white text-sm border"><option value="">+ é…ä»¶ 3</option><option>å…’ç«¥åº§æ¤…</option><option>å®šæ™‚å™¨</option><option>æ°´æ¯æ¶</option><option>é›™æ¯æ‰‹æ©Ÿæ¶</option><option>å¾Œç…§é¡2é•·</option><option>å¾Œåº§é èƒŒ</option><option>å¾Œè…³è¸/å¡‘</option><option>å¾Œè…³è¸/éµ</option></select>
                                <select class="f-ps p-3 rounded-xl font-bold bg-white text-sm border"><option value="">+ é…ä»¶ 4</option><option>å…’ç«¥åº§æ¤…</option><option>å®šæ™‚å™¨</option><option>æ°´æ¯æ¶</option><option>é›™æ¯æ‰‹æ©Ÿæ¶</option><option>å¾Œç…§é¡2é•·</option><option>å¾Œåº§é èƒŒ</option><option>å¾Œè…³è¸/å¡‘</option><option>å¾Œè…³è¸/éµ</option></select>
                            </div>
                            <div class="grid grid-cols-2 gap-2 border-t pt-4">
                                <input type="text" id="f-custom-item" placeholder="è‡ªè¨‚é …ç›®" class="p-4 rounded-xl font-bold bg-white text-sm border">
                                <input type="number" id="f-custom-cost" placeholder="é¡å¤–æˆæœ¬" class="p-4 rounded-xl font-bold bg-white text-red-600 text-sm border">
                            </div>
                        </div>
                        <input type="text" id="f-cust" placeholder="å‚™è¨»" class="w-full p-5 rounded-2xl bg-white border outline-none font-bold">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="f-cash" placeholder="ğŸ’° ç¾é‡‘æ”¶" class="p-6 rounded-2xl bg-amber-50 font-black text-amber-800 text-center text-xl border">
                            <input type="number" id="f-bank" placeholder="ğŸ¦ è½‰å¸³æ”¶" class="p-6 rounded-2xl bg-blue-50 font-black text-blue-800 text-center text-xl border">
                        </div>
                        <div class="flex gap-3">
                            <button type="button" onclick="resetForm()" class="px-8 py-6 rounded-3xl font-black bg-slate-200 text-slate-600">é‡ç½®</button>
                            <button type="button" onclick="doSave()" class="flex-1 py-6 rounded-3xl font-black text-2xl bg-slate-900 text-white shadow-xl">ç¢ºèªå„²å­˜</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-7 space-y-6">
                    <div id="stk-grid" class="grid grid-cols-3 md:grid-cols-5 gap-3"></div>
                    <div class="bg-white rounded-[2.5rem] shadow-xl border overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b">
                                <tr class="text-slate-400 font-black text-xs uppercase"><th class="p-6">æ‘˜è¦</th><th class="p-6">å…§å®¹</th><th class="p-6 text-right">é‡‘é¡</th><th class="p-6 text-center">åˆª</th></tr>
                            </thead>
                            <tbody id="log-list" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-report" class="hidden">
            <div id="fin-assets" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-8 bg-white rounded-[2.5rem] shadow-xl border p-8 overflow-x-auto">
                    <h3 class="font-black text-xl mb-6 flex items-center"><span class="w-2 h-6 bg-indigo-600 rounded-full mr-2"></span>éŠ·å”®åˆ©æ½¤æ˜ç´°</h3>
                    <div id="profit-table-area"></div>
                </div>
                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-slate-900 text-white rounded-[2.5rem] p-8 shadow-2xl">
                        <h3 class="font-black text-xl mb-4">åˆ©æ½¤æé ˜ç´€éŒ„</h3>
                        <div class="space-y-4">
                            <input type="number" id="f-withdraw" placeholder="è¼¸å…¥æé ˜é‡‘é¡" class="w-full p-4 rounded-xl bg-slate-800 border-none text-white text-2xl font-black">
                            <button onclick="addWithdraw()" class="w-full py-4 rounded-xl bg-indigo-500 font-black hover:bg-indigo-400 transition">ç¢ºèªæé ˜</button>
                        </div>
                        <div id="withdraw-list" class="mt-8 space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const COST_MAP = { "Jå¯„è³£æ¬¾(8)": 9000, "Jå¯„è³£æ¬¾/è»Š": 7500, "Gé’æ˜¥ç‰ˆ(8)": 5980, "Qç‰¹æƒ ç‰ˆ": 5000, "Wé«˜é…ç‰ˆ": 5335, "Qç‰¹æƒ Xé˜²ç›œ": 4000, "8AH": 0, "20AH": 1650, "30AH": 1970, "å…’ç«¥åº§æ¤…": 500, "å®šæ™‚å™¨": 90, "æ°´æ¯æ¶": 70, "é›™æ¯æ‰‹æ©Ÿæ¶": 155, "å¾Œç…§é¡2é•·": 75, "å¾Œåº§é èƒŒ": 100, "å¾Œè…³è¸/å¡‘": 80, "å¾Œè…³è¸/éµ": 60, "ç¶­ä¿®æœå‹™": 0 };
        const KEY = "YUCHILL_DB_V71";
        // çµæ§‹æ›´æ–°ï¼šæ–°å¢ withdraws é™£åˆ—
        let db = JSON.parse(localStorage.getItem(KEY)) || { 
            stock: { "Jå¯„è³£æ¬¾(8)":0, "Jå¯„è³£æ¬¾/è»Š":0, "Gé’æ˜¥ç‰ˆ(8)":0, "Qç‰¹æƒ ç‰ˆ":0, "Wé«˜é…ç‰ˆ":0, "Qç‰¹æƒ Xé˜²ç›œ":0, "8AH":0, "20AH":0, "30AH":0, "å…’ç«¥åº§æ¤…":0, "å®šæ™‚å™¨":0, "æ°´æ¯æ¶":0, "é›™æ¯æ‰‹æ©Ÿæ¶":0, "å¾Œç…§é¡2é•·":0, "å¾Œåº§é èƒŒ":0, "å¾Œè…³è¸/å¡‘":0, "å¾Œè…³è¸/éµ":0 }, 
            logs: [],
            withdraws: [] 
        };
        let currentMode = 'sell';

        function generateNextBarcode() {
            const carEl = document.getElementById('f-car-type');
            const carCode = carEl.options[carEl.selectedIndex]?.dataset.code;
            const colorCode = document.getElementById('f-color').value || "0";
            const dateStr = document.getElementById('f-date').value;
            if(!carCode || !dateStr) return "";
            const shortDate = dateStr.replace(/-/g, '').substring(2);
            const matchedLogs = db.logs.filter(l => !l.void && l.barcode && l.barcode.startsWith(carCode) && /^\d{2}$/.test(l.barcode.slice(-2)));
            let maxNum = 0;
            if (matchedLogs.length > 0) {
                const allNums = matchedLogs.map(l => parseInt(l.barcode.slice(-2)));
                maxNum = Math.max(...allNums);
            }
            const final = `${carCode}${colorCode}${shortDate}${(maxNum + 1).toString().padStart(2, '0')}`;
            document.getElementById('f-barcode').value = final;
            return final;
        }

        function handleBarcodeInput(val) {
            if(currentMode !== 'sell' || val.length < 5) return;
            const target = db.logs.find(l => !l.void && l.type === 'buy' && l.barcode === val.toUpperCase());
            if(target) {
                document.getElementById('f-car-type').value = target.carName;
                document.getElementById('f-vin').value = target.vin || "";
                document.getElementById('f-motor').value = target.motor || "";
                document.getElementById('f-batt').value = target.batt || "";
                document.getElementById('f-color').value = val.substring(1,2);
                document.getElementById('f-barcode').classList.add('bg-green-50');
            }
        }

        function autoRefreshBarcode() { if(currentMode === 'buy') generateNextBarcode(); }

        function doSave() {
            const dateVal = document.getElementById('f-date').value;
            if(!dateVal) return alert("è«‹é¸æ“‡æ—¥æœŸ");
            const qty = currentMode === 'buy' ? (parseInt(document.getElementById('f-qty').value) || 1) : 1;
            const carName = document.getElementById('f-car-type').value || "ç¶­ä¿®é …ç›®";
            const ps = Array.from(document.querySelectorAll('.f-ps')).map(s => s.value);

            for(let i=0; i<qty; i++) {
                let codeToUse = (currentMode === 'buy') ? generateNextBarcode() : document.getElementById('f-barcode').value;
                if(!codeToUse && currentMode==='sell') codeToUse = "æ‰‹å‹•éŠ·è²¨";

                let baseCost = (COST_MAP[carName] || 0) + (COST_MAP[document.getElementById('f-batt').value] || 0);
                ps.forEach(p => { if(p) baseCost += (COST_MAP[p] || 0); });
                baseCost += (parseInt(document.getElementById('f-custom-cost').value) || 0);

                const entry = {
                    date: dateVal, carName, ps: [...ps], barcode: codeToUse,
                    vin: document.getElementById('f-vin').value, motor: document.getElementById('f-motor').value,
                    cust: document.getElementById('f-cust').value, baseCost: baseCost,
                    type: currentMode, void: false,
                    cash: i===0 ? (parseInt(document.getElementById('f-cash').value)||0) : 0,
                    bank: i===0 ? (parseInt(document.getElementById('f-bank').value)||0) : 0,
                    customItem: document.getElementById('f-custom-item').value, batt: document.getElementById('f-batt').value
                };
                db.logs.unshift(entry);
                const mod = (currentMode === 'sell' ? -1 : 1);
                if(db.stock[carName] !== undefined) db.stock[carName] += mod;
                ps.forEach(p => { if(p && db.stock[p] !== undefined) db.stock[p] += mod; });
                localStorage.setItem(KEY, JSON.stringify(db));
            }
            render(); resetForm(); alert(`æˆåŠŸå„²å­˜ ${qty} ç­†ç´€éŒ„`);
        }

        function resetForm() {
            document.getElementById('main-form').reset();
            document.getElementById('f-date').valueAsDate = new Date();
            document.getElementById('f-qty').value = "1";
            document.getElementById('f-barcode').classList.remove('bg-green-50');
            if(currentMode === 'buy') document.getElementById('f-barcode').value = "";
        }

        function switchTab(t) {
            document.getElementById('page-main').style.display = t==='main'?'block':'none';
            document.getElementById('page-report').style.display = t==='report'?'block':'none';
            document.getElementById('tab-main').className = (t==='main'?'tab-active ':'text-slate-500 ') + 'px-8 py-2 rounded-xl font-black';
            document.getElementById('tab-report').className = (t==='report'?'tab-active ':'text-slate-500 ') + 'px-8 py-2 rounded-xl font-black';
            if(t==='report') renderFinance();
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('m-sell').className = (m==='sell'?'bg-white text-indigo-600 shadow-sm ':'text-slate-400 ') + 'flex-1 py-4 rounded-xl font-black';
            document.getElementById('m-buy').className = (m==='buy'?'bg-white text-orange-600 shadow-sm ':'text-slate-400 ') + 'flex-1 py-4 rounded-xl font-black';
            document.getElementById('buy-qty-area').classList.toggle('hidden', m!=='buy');
            resetForm(); 
        }

        function render() {
            document.getElementById('stk-grid').innerHTML = Object.entries(db.stock).map(([k,v]) => `<div class="bg-white p-4 rounded-2xl border text-center shadow-sm"><div class="text-[10px] font-black text-slate-300 truncate mb-1">${k}</div><div class="text-xl font-black ${v<=0?'text-slate-200':'text-indigo-600'}">${v}</div></div>`).join('');
            document.getElementById('log-list').innerHTML = db.logs.map((l, idx) => `
                <tr class="${l.void?'void-line':''}">
                    <td class="p-6">
                        <div class="text-[10px] text-slate-400 font-black mb-1">${l.date}</div>
                        <div class="log-title font-mono uppercase">${l.barcode}</div>
                    </td>
                    <td class="p-6">
                        <div class="log-title">${l.carName}</div>
                        <div class="log-detail">${l.ps.filter(x=>x).join(' + ')} ${l.customItem?`â˜…${l.customItem}`:''}</div>
                        <div class="text-[10px] font-bold text-slate-400 mt-1 uppercase font-mono">${l.vin||'ç„¡'} / ${l.motor||'ç„¡'}</div>
                    </td>
                    <td class="p-6 text-right font-black text-2xl ${l.type==='buy'?'text-orange-500':'text-slate-950'}">${l.type==='buy'?'-':''}$${(l.cash+l.bank).toLocaleString()}</td>
                    <td class="p-6 text-center"><button onclick="askUndo(${idx})" class="text-slate-300 text-3xl">Ã—</button></td>
                </tr>`).join('');
            localStorage.setItem(KEY, JSON.stringify(db));
        }

        function askUndo(idx) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) {
                const l = db.logs[idx];
                const mod = (l.type === 'sell' ? 1 : -1);
                if(db.stock[l.carName] !== undefined) db.stock[l.carName] += mod;
                l.ps.forEach(p => { if(p && db.stock[p] !== undefined) db.stock[p] += mod; });
                l.void = true;
                render();
            }
        }

        // --- å ±è¡¨èˆ‡æé ˜é‚è¼¯ ---
        function addWithdraw() {
            const amt = parseInt(document.getElementById('f-withdraw').value);
            if(!amt || amt <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡");
            db.withdraws.unshift({ date: new Date().toLocaleDateString(), amount: amt });
            document.getElementById('f-withdraw').value = "";
            renderFinance();
            localStorage.setItem(KEY, JSON.stringify(db));
        }

        function delWithdraw(idx) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤æé ˜ç´€éŒ„ï¼Ÿ")) {
                db.withdraws.splice(idx, 1);
                renderFinance();
                localStorage.setItem(KEY, JSON.stringify(db));
            }
        }

        function renderFinance() {
            let totalProfit = 0, stockCost = 0;
            const activeLogs = db.logs.filter(l => !l.void && l.type === 'sell');
            Object.entries(db.stock).forEach(([n, q]) => { if(q>0) stockCost += (q * (COST_MAP[n]||0)); });
            
            // è¨ˆç®—æé ˜
            const totalWithdrawn = db.withdraws.reduce((sum, w) => sum + w.amount, 0);

            let html = `<table class="w-full text-left"><thead><tr class="text-slate-400 text-sm border-b"><th class="pb-4">æ¢ç¢¼/æ—¥æœŸ</th><th class="pb-4">é …ç›®</th><th class="pb-4 text-right">æˆæœ¬</th><th class="pb-4 text-right">å¯¦æ”¶</th><th class="pb-4 text-right">åˆ©æ½¤</th></tr></thead><tbody>`;
            activeLogs.forEach(l => {
                const income = (l.cash + l.bank);
                const profit = income - l.baseCost;
                totalProfit += profit;
                html += `<tr class="border-b border-slate-50"><td class="py-4 font-mono font-black text-xs text-indigo-600 uppercase">${l.barcode}<br><span class="text-slate-300">${l.date}</span></td><td class="py-4 font-bold text-sm">${l.carName}</td><td class="text-right text-slate-300 text-sm">$${l.baseCost.toLocaleString()}</td><td class="text-right font-black">$${income.toLocaleString()}</td><td class="text-right font-black ${profit<0?'text-red-500':'text-emerald-600'}">$${profit.toLocaleString()}</td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('profit-table-area').innerHTML = html;

            // æé ˜åˆ—è¡¨
            document.getElementById('withdraw-list').innerHTML = db.withdraws.map((w, i) => `
                <div class="flex justify-between items-center bg-slate-800 p-3 rounded-xl border border-slate-700">
                    <div><span class="text-[10px] block opacity-50">${w.date}</span><span class="font-black">$${w.amount.toLocaleString()}</span></div>
                    <button onclick="delWithdraw(${i})" class="text-red-400 font-bold">åˆªé™¤</button>
                </div>
            `).join('');

            // æ ¸å¿ƒå…¬å¼ï¼š
            // [å¯æåˆ©æ½¤] = ç¸½åˆ©æ½¤ - é…ç½®åº«å­˜å‰©é¤˜ (10è¬ - ç›®å‰åœ¨åº«)
            const reserveNeeded = Math.max(0, 100000 - stockCost);
            const canWithdrawTotal = totalProfit - reserveNeeded;
            const remainingWithdraw = canWithdrawTotal - totalWithdrawn;

            document.getElementById('fin-assets').innerHTML = `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100"><div class="text-xs font-black text-slate-400 mb-1">éŠ·å”®ç¸½åˆ©æ½¤</div><div class="text-2xl font-black text-slate-900">$${totalProfit.toLocaleString()}</div></div>
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100"><div class="text-xs font-black text-indigo-400 mb-1">å¯æåˆ©æ½¤ (æ‰£é™¤é ç•™)</div><div class="text-2xl font-black text-indigo-600">$${canWithdrawTotal.toLocaleString()}</div></div>
                <div class="bg-slate-200 p-6 rounded-[2rem] shadow-sm"><div class="text-xs font-black text-slate-500 mb-1">å·²æåˆ©æ½¤</div><div class="text-2xl font-black text-slate-700">$${totalWithdrawn.toLocaleString()}</div></div>
                <div class="${remainingWithdraw < 0 ? 'bg-red-500' : 'bg-emerald-500'} p-6 rounded-[2rem] text-white shadow-xl flex flex-col justify-center">
                    <div class="text-xs font-black opacity-80 mb-1">å‰©é¤˜åˆ©æ½¤ (é¤˜é¡)</div>
                    <div class="text-3xl font-black">$${remainingWithdraw.toLocaleString()}</div>
                </div>`;
        }

        function exportData() { const blob = new Blob([JSON.stringify(db, null, 2)], {type: "application/json"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `YUCHILL_V71.json`; a.click(); }
        
        document.getElementById('f-date').valueAsDate = new Date();
        render();
    </script>
    <script>
/* ========= å…¨åŸŸç‹€æ…‹ ========= */
let currentMode = 'sell';

/* ========= åˆ†é åˆ‡æ› ========= */
function switchTab(tab) {
    document.getElementById('page-main').classList.add('hidden');
    document.getElementById('page-report').classList.add('hidden');

    document.getElementById('tab-main').classList.remove('tab-active');
    document.getElementById('tab-report').classList.remove('tab-active');

    document.getElementById(`page-${tab}`).classList.remove('hidden');
    document.getElementById(`tab-${tab}`).classList.add('tab-active');
}

/* ========= è²· / è³£ æ¨¡å¼ ========= */
function setMode(mode) {
    currentMode = mode;

    document.getElementById('m-sell').classList.remove('bg-white','shadow-sm','text-indigo-600');
    document.getElementById('m-buy').classList.remove('bg-white','shadow-sm','text-orange-600');

    if (mode === 'sell') {
        document.getElementById('m-sell').classList.add('bg-white','shadow-sm','text-indigo-600');
        document.getElementById('buy-qty-area').classList.add('hidden');
    } else {
        document.getElementById('m-buy').classList.add('bg-white','shadow-sm','text-orange-600');
        document.getElementById('buy-qty-area').classList.remove('hidden');
    }
}

/* ========= æ¢ç¢¼ ========= */
function generateNextBarcode() {
    const date = document.getElementById('f-date').value || new Date().toISOString().slice(0,10);
    const code = 'YC-' + date.replaceAll('-','') + '-' + Math.floor(Math.random()*900+100);
    document.getElementById('f-barcode').value = code;
}

function autoRefreshBarcode() {
    if (!document.getElementById('f-barcode').value) {
        generateNextBarcode();
    }
}

function handleBarcodeInput(val) {
    // ç›®å‰ä¿ç•™ï¼Œä¹‹å¾Œä½ å¯ä»¥åŠ æƒç¢¼é‚è¼¯
}

/* ========= è¡¨å–® ========= */
function resetForm() {
    document.getElementById('main-form').reset();
    setMode('sell');
}

function doSave() {
    alert('âœ… å·²å„²å­˜ï¼ˆç›®å‰ç¤ºç¯„ç‰ˆï¼‰');
}

/* ========= åŒ¯å‡º ========= */
function exportData() {
    alert('ğŸ“¦ åŒ¯å‡ºåŠŸèƒ½å¾…æ¥è³‡æ–™çµæ§‹');
}

/* ========= é è¨­åˆå§‹åŒ– ========= */
document.addEventListener('DOMContentLoaded', () => {
    setMode('sell');
});
</script>
</body>
</html>