<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="apple-touch-icon" href="icon-512.png?v=101">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="YUCHILL">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #qr-reader-wrapper {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 10000;
            flex-direction: column;
        }
        #reader { width: 100% !important; height: 100% !important; }
        #reader img { display: none !important; }
        #reader video { object-fit: cover !important; }
        .scan-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 280px; height: 180px;
            border: 2px solid rgba(79, 70, 229, 0.5);
            border-radius: 12px;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.5);
            z-index: 10;
            pointer-events: none;
        }
        .scan-line {
            position: absolute;
            width: 100%; height: 2px;
            background: #4f46e5;
            box-shadow: 0 0 10px #4f46e5;
            animation: scanMove 2s infinite;
        }
        @keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }
        .scan-ui-overlay { position: absolute; bottom: 40px; width: 100%; text-align: center; z-index: 11; }
    </style>
</head>
<body class="bg-slate-50 pb-10">
    <div id="qr-reader-wrapper">
        <div id="reader"></div>
        <div class="scan-overlay"><div class="scan-line"></div></div>
        <div class="scan-ui-overlay">
            <p class="text-white mb-6 font-bold">è«‹å°‡æ¢ç¢¼å°æº–æ¡†å…§</p>
            <button onclick="stopScan()" class="bg-red-500 text-white px-10 py-4 rounded-full font-black shadow-lg">çµæŸæƒæ</button>
        </div>
    </div>

    <nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <h1 class="font-black text-2xl italic">YUCHILL <span class="text-indigo-600 text-sm">5207418</span></h1>
            <button onclick="exportData()" class="bg-white border px-4 py-2 rounded-xl font-bold text-sm shadow-sm">å‚™ä»½è³‡æ–™</button>
            <button onclick="clearAllData()" class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-sm ml-2">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
        </div>
        <div class="px-4 pb-3">
            <div class="flex w-full bg-slate-100 rounded-2xl p-1 max-w-md mx-auto">
                <button onclick="switchTab('main')" id="tab-main" class="tab-active flex-1 py-3 rounded-xl font-black transition-all bg-white shadow-sm">æ¥­å‹™è™•ç†</button>
                <button onclick="switchTab('report')" id="tab-report" class="flex-1 py-3 rounded-xl font-black text-slate-500 transition-all">åˆ©æ½¤å ±è¡¨</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-3 sm:p-4 mt-3">
        <div id="page-main">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-5">
                    <form id="main-form" class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100 space-y-6">
                        <div class="flex bg-slate-100 rounded-2xl p-1 font-black">
                            <button type="button" onclick="setMode('sell')" id="m-sell" class="flex-1 py-4 rounded-xl bg-white shadow-sm text-indigo-600">éŠ·å”® / æœå‹™</button>
                            <button type="button" onclick="setMode('buy')" id="m-buy" class="flex-1 py-4 rounded-xl text-slate-400">æ¡è³¼ / é€²è²¨</button>
                        </div>

                        <div class="flex gap-10">
                            <div class="flex-1.5">
                                <label class="text-xs font-black text-slate-400 ml-1">äº¤æ˜“æ—¥æœŸ</label>
                                <input type="date" id="f-date" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-bold">
                            </div>
                            <div id="buy-qty-area" class="hidden w-16 flex-shrink-0">

                                <label class="text-xs font-black text-orange-500 ml-4">æ•¸é‡</label>
                                <input type="number" id="f-qty" value="1" min="1" inputmode="numeric" class="w-full bg-orange-50 py-4 px-4 rounded-2xl font-black text-orange-600 text-center border border-orange-200 outline-none">
                            </div>
                        </div>

                        <div class="p-5 bg-indigo-50/50 rounded-[2rem] border border-indigo-100 space-y-4">
                            <div class="flex flex-col gap-2">
                                <label class="text-xs font-black text-indigo-400 ml-1">æ¢ç¢¼ç·¨è™Ÿ</label>
                                <div class="relative w-full">
  <input type="text" id="f-barcode" 
    oninput="handleBarcodeInput(this.value)" 
    placeholder="æ‰‹å‹•è¼¸å…¥æˆ–æƒæ" 
    class="w-full p-4 pr-16 rounded-2xl font-black text-indigo-700 text-center uppercase bg-white border border-indigo-200 shadow-sm outline-none">
  
  <button type="button" 
    onclick="handleBarcodeScan()" 
    class="absolute right-2 top-1/2 -translate-y-1/2 bg-indigo-600 w-12 h-12 rounded-2xl text-white shadow-lg hover:bg-indigo-700 transition flex items-center justify-center">
    
    <span class="text-xl">ğŸ“·</span>
  </button>
</div>
                                <input type="file" id="barcodeFileInput" accept="image/*" capture="environment" class="hidden">
                            </div>
                                            
                            <div class="grid grid-cols-2 gap-2">
                                <select id="f-car-type" onchange="autoRefreshBarcode()" class="p-4 rounded-xl font-black bg-white border border-slate-200">
                                    <option value="">- è»Šçµ„ -</option>
                                    <option data-code="J">Jå¯„è³£æ¬¾(8)</option><option data-code="J">Jå¯„è³£æ¬¾/è»Š</option><option data-code="G">Gé’æ˜¥ç‰ˆ(8)</option>
                                    <option data-code="Q">Qç‰¹æƒ ç‰ˆ</option><option data-code="W">Wé«˜é…ç‰ˆ</option><option data-code="Q">Qç‰¹æƒ Xé˜²ç›œ</option>
                                    <option data-code="S" value="ç¶­ä¿®æœå‹™">ç¶­ä¿®æœå‹™</option>
                                </select>
                                <select id="f-color" onchange="autoRefreshBarcode()" class="p-4 rounded-xl font-black bg-white border border-slate-200">
                                    <option value="">- é¡è‰² -</option>
                                    <option value="1">é»‘</option><option value="2">ç™½</option><option value="3">ç²‰</option><option value="4">è—</option><option value="5">ç´«</option><option value="6">ç´…</option>
                                </select>
                            </div>
                            <div class="flex flex-col gap-2">
                                <input type="text" id="f-vin" placeholder="è»Šæ¶è™Ÿ" class="w-full p-4 rounded-xl font-bold bg-white text-base border border-slate-200">
                                <input type="text" id="f-motor" placeholder="é›»æ©Ÿè™Ÿ" class="w-full p-4 rounded-xl font-bold bg-white text-base border border-slate-200">
                            </div>
                            <select id="f-batt" class="w-full p-4 rounded-xl font-black bg-white border border-slate-200">
                                <option value="">- é›»æ±  -</option><option>8AH</option><option>20AH</option><option>30AH</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="f-cash" inputmode="numeric" placeholder="ğŸ’° ç¾é‡‘æ”¶" class="p-6 rounded-2xl bg-amber-50 font-black text-amber-800 text-center text-xl border border-amber-100">
                            <input type="number" id="f-bank" inputmode="numeric" placeholder="ğŸ¦ è½‰å¸³æ”¶" class="p-6 rounded-2xl bg-blue-50 font-black text-blue-800 text-center text-xl border border-blue-100">
                        </div>

                        <div class="flex gap-3">
                            <button type="button" onclick="resetForm()" class="px-8 py-6 rounded-3xl font-black bg-slate-200 text-slate-600">é‡ç½®</button>
                            <button type="button" onclick="doSave()" class="flex-1 py-6 rounded-3xl font-black text-2xl bg-slate-900 text-white shadow-xl">ç¢ºèªå„²å­˜</button>
                        </div>
                    </form>
                </div>

                <div class="lg:col-span-7 space-y-6">
                    <div id="stk-grid" class="grid grid-cols-3 md:grid-cols-5 gap-3"></div>
                    <div class="bg-white rounded-[2.5rem] shadow-xl border overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b">
                                <tr class="text-slate-400 font-black text-xs uppercase"><th class="p-6">æ‘˜è¦</th><th class="p-6">å…§å®¹</th><th class="p-6 text-right">é‡‘é¡</th><th class="p-6 text-center">åˆª</th></tr>
                            </thead>
                            <tbody id="log-list" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-report" class="hidden">
            <div id="fin-assets" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"></div>
            <div id="profit-table-area" class="bg-white rounded-[2.5rem] shadow-xl border p-8 overflow-x-auto mb-8"></div>
            <div class="bg-slate-900 text-white rounded-[2.5rem] p-8 shadow-2xl max-w-md">
                <h3 class="font-black text-xl mb-4">åˆ©æ½¤æé ˜ç´€éŒ„</h3>
                <div class="space-y-4">
                    <input type="number" id="f-withdraw" placeholder="è¼¸å…¥æé ˜é‡‘é¡" class="w-full p-4 rounded-xl bg-slate-800 border-none text-white text-2xl font-black">
                    <button onclick="addWithdraw()" class="w-full py-4 rounded-xl bg-indigo-500 font-black hover:bg-indigo-400">ç¢ºèªæé ˜</button>
                </div>
                <div id="withdraw-list" class="mt-8 space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        const COST_MAP = { "Jå¯„è³£æ¬¾(8)": 9000, "Jå¯„è³£æ¬¾/è»Š": 7500, "Gé’æ˜¥ç‰ˆ(8)": 5980, "Qç‰¹æƒ ç‰ˆ": 5000, "Wé«˜é…ç‰ˆ": 5335, "Qç‰¹æƒ Xé˜²ç›œ": 4000, "8AH": 0, "20AH": 1650, "30AH": 1970, "å…’ç«¥åº§æ¤…": 500, "å®šæ™‚å™¨": 90, "æ°´æ¯æ¶": 70, "é›™æ¯æ‰‹æ©Ÿæ¶": 155, "å¾Œç…§é¡2é•·": 75, "å¾Œåº§é èƒŒ": 100, "å¾Œè…³è¸/å¡‘": 80, "å¾Œè…³è¸/éµ": 60, "ç¶­ä¿®æœå‹™": 0 };
        const KEY = "YUCHILL_DB_V71";
        
        let db = JSON.parse(localStorage.getItem(KEY)) || { 
            stock: { "Jå¯„è³£æ¬¾(8)":0, "Jå¯„è³£æ¬¾/è»Š":0, "Gé’æ˜¥ç‰ˆ(8)":0, "Qç‰¹æƒ ç‰ˆ":0, "Wé«˜é…ç‰ˆ":0, "Qç‰¹æƒ Xé˜²ç›œ":0, "8AH":0, "20AH":0, "30AH":0, "å…’ç«¥åº§æ¤…":0, "å®šæ™‚å™¨":0, "æ°´æ¯æ¶":0, "é›™æ¯æ‰‹æ©Ÿæ¶":0, "å¾Œç…§é¡2é•·":0, "å¾Œåº§é èƒŒ":0, "å¾Œè…³è¸/å¡‘":0, "å¾Œè…³è¸/éµ":0 }, 
            logs: [],
            withdraws: [] 
        };
        let currentMode = 'sell';

        function switchTab(t) {
            document.getElementById('page-main').style.display = t === 'main' ? 'block' : 'none';
            document.getElementById('page-report').style.display = t === 'report' ? 'block' : 'none';
            document.getElementById('tab-main').className = t === 'main' ? "flex-1 py-3 rounded-xl font-black transition-all bg-white shadow-sm" : "flex-1 py-3 rounded-xl font-black text-slate-500 transition-all";
            document.getElementById('tab-report').className = t === 'report' ? "flex-1 py-3 rounded-xl font-black transition-all bg-white shadow-sm" : "flex-1 py-3 rounded-xl font-black text-slate-500 transition-all";
            if(t === 'report') renderFinance();
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('m-sell').className = (m==='sell'?'bg-white text-indigo-600 shadow-sm ':'text-slate-400 ') + 'flex-1 py-4 rounded-xl font-black';
            document.getElementById('m-buy').className = (m==='buy'?'bg-white text-orange-600 shadow-sm ':'text-slate-400 ') + 'flex-1 py-4 rounded-xl font-black';
            document.getElementById('buy-qty-area').classList.toggle('hidden', m!=='buy');
            resetForm(); 
        }

        function generateNextBarcode(index = 0) {
    const carEl = document.getElementById('f-car-type');
    const carCode = carEl.options[carEl.selectedIndex]?.dataset.code;
    const colorCode = document.getElementById('f-color').value || "0"; // é€™è£¡æœƒè‡ªå‹•å¸¶å…¥ 1~2 ä½æ•¸
    const dateStr = document.getElementById('f-date').value;

    if (!carCode || !dateStr) return "";

    const shortDate = dateStr.replace(/-/g, '').substring(2);

    // ä¿®æ­£ï¼šåªè¦é–‹é ­æ˜¯è©²è»Šçµ„ä»£è™Ÿçš„éƒ½åˆ—å…¥è¨ˆç®—ï¼Œä¸é™æ¢ç¢¼é•·åº¦
    const matchedLogs = db.logs.filter(l => 
        !l.void && 
        l.barcode && 
        l.barcode.startsWith(carCode)
    );

    let maxNum = 0;
    if (matchedLogs.length > 0) {
        // ä¿®æ­£ï¼šæ°¸é å–æ¢ç¢¼æœ€å¾Œå…©ä½æ•¸ä½œç‚ºæµæ°´è™Ÿåˆ¤æ–·
        const nums = matchedLogs.map(l => parseInt(l.barcode.slice(-2))).filter(n => !isNaN(n));
        if (nums.length > 0) maxNum = Math.max(...nums);
    }

    // é‡é»ï¼šmaxNum + 1 æ˜¯ä¸‹ä¸€ç­†èµ·å§‹è™Ÿï¼Œå†åŠ ä¸Š index é”æˆæ‰¹æ¬¡éå¢
    const nextNum = (maxNum + 1 + index).toString().padStart(2, '0');
    
    return `${carCode}${colorCode}${shortDate}${nextNum}`;
}


        function handleBarcodeInput(val) {
            if(currentMode !== 'sell' || val.length < 5) return;
            const target = db.logs.find(l => !l.void && l.type === 'buy' && l.barcode === val.toUpperCase());
            if(target) {
                document.getElementById('f-car-type').value = target.carName;
                document.getElementById('f-vin').value = target.vin || "";
                document.getElementById('f-motor').value = target.motor || "";
                document.getElementById('f-batt').value = target.batt || "";
                document.getElementById('f-color').value = val.substring(1,2);
                document.getElementById('f-barcode').style.backgroundColor = "#f0fdf4";
            }
        }

        function autoRefreshBarcode() { 
            if(currentMode === 'buy') {
                const newCode = generateNextBarcode();
                if(newCode) document.getElementById('f-barcode').value = newCode;
            }
        }

        function doSave() {
    const dateVal = document.getElementById('f-date').value;
    if(!dateVal) return alert("è«‹é¸æ“‡æ—¥æœŸ");
    const qty = currentMode === 'buy' ? (parseInt(document.getElementById('f-qty').value) || 1) : 1;
    const carName = document.getElementById('f-car-type').value || "ç¶­ä¿®é …ç›®";
    const batt = document.getElementById('f-batt').value;

    // --- æ–°å¢é€™è¡Œ ---
    for(let i=0; i<qty; i++) {
        // æ¯ä¸€åœˆéƒ½æœƒå› ç‚ºå‰ä¸€åœˆå·² push åˆ° db.logs è€Œè‡ªå‹•å–å¾—æ­£ç¢ºçš„ä¸‹ä¸€è™Ÿ
        let codeToUse = (currentMode === 'buy') ? generateNextBarcode() : document.getElementById('f-barcode').value.toUpperCase();
        if(!codeToUse) codeToUse = "MANUAL";

        const entry = {
            date: dateVal, carName, barcode: codeToUse,
            vin: document.getElementById('f-vin').value, motor: document.getElementById('f-motor').value,
            type: currentMode, void: false,
            cash: i===0 ? (parseInt(document.getElementById('f-cash').value)||0) : 0,
            bank: i===0 ? (parseInt(document.getElementById('f-bank').value)||0) : 0,
            batt, ps: [] 
        };
        
        db.logs.unshift(entry); // å­˜å…¥å¾Œï¼Œä¸‹ä¸€åœˆ generateNextBarcode å°±æœƒçœ‹åˆ°é€™ä¸€ç­†
        const mod = (currentMode === 'sell' ? -1 : 1);
        if(db.stock[carName] !== undefined) db.stock[carName] += mod;
        if(batt && db.stock[batt] !== undefined) db.stock[batt] += mod;
    } 
    // --- æ–°å¢é€™è¡Œ ---

    localStorage.setItem(KEY, JSON.stringify(db));
    render(); resetForm(); alert(`æˆåŠŸå„²å­˜ ${qty} ç­†`);
}


        function resetForm() {
            document.getElementById('main-form').reset();
            document.getElementById('f-date').valueAsDate = new Date();
            document.getElementById('f-barcode').style.backgroundColor = "";
            autoRefreshBarcode();
        }

        function render() {
            document.getElementById('stk-grid').innerHTML = Object.entries(db.stock).map(([k,v]) => `<div class="bg-white p-4 rounded-2xl border text-center shadow-sm"><div class="text-[10px] font-black text-slate-300 truncate mb-1">${k}</div><div class="text-xl font-black ${v<=0?'text-slate-200':'text-indigo-600'}">${v}</div></div>`).join('');
            document.getElementById('log-list').innerHTML = db.logs.map((l, idx) => `
                <tr class="${l.void?'opacity-30 line-through':''}">
                    <td class="p-6">
                        <div class="text-[10px] text-slate-400 font-black mb-1">${l.date}</div>
                        <div class="font-mono font-bold uppercase">${l.barcode}</div>
                    </td>
                    <td class="p-6">
                        <div class="font-bold">${l.carName}</div>
                        <div class="text-[10px] text-slate-400 font-mono">${l.vin||'ç„¡'} / ${l.motor||'ç„¡'}</div>
                    </td>
                    <td class="p-6 text-right font-black text-xl ${l.type==='buy'?'text-orange-500':'text-slate-950'}">${l.type==='buy'?'-':''}$${(l.cash+l.bank).toLocaleString()}</td>
                    <td class="p-6 text-center"><button onclick="askUndo(${idx})" class="text-slate-300 text-2xl">Ã—</button></td>
                </tr>`).join('');
        }

        function askUndo(idx) {
            if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                const l = db.logs[idx];
                const mod = (l.type === 'sell' ? 1 : -1);
                if(db.stock[l.carName] !== undefined) db.stock[l.carName] += mod;
                if(l.batt && db.stock[l.batt] !== undefined) db.stock[l.batt] += mod;
                l.void = true;
                localStorage.setItem(KEY, JSON.stringify(db));
                render();
            }
        }

        function renderFinance() {
            let totalProfit = 0, stockCost = 0;
            const activeLogs = db.logs.filter(l => !l.void && l.type === 'sell');
            Object.entries(db.stock).forEach(([n, q]) => { if(q>0) stockCost += (q * (COST_MAP[n]||0)); });
            const totalWithdrawn = db.withdraws.reduce((sum, w) => sum + w.amount, 0);

            let html = `<h3 class="font-black text-xl mb-6">éŠ·å”®åˆ©æ½¤æ˜ç´°</h3><table class="w-full text-left"><thead><tr class="text-slate-400 text-sm border-b"><th class="pb-4">æ¢ç¢¼</th><th class="pb-4">é …ç›®</th><th class="pb-4 text-right">åˆ©æ½¤</th></tr></thead><tbody>`;
            activeLogs.forEach(l => {
                const income = (l.cash + l.bank);
                const profit = income - (l.baseCost || 0);
                totalProfit += profit;
                html += `<tr class="border-b border-slate-50"><td class="py-4 font-mono text-xs">${l.barcode}</td><td class="py-4 font-bold text-sm">${l.carName}</td><td class="text-right font-black text-emerald-600">$${profit.toLocaleString()}</td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('profit-table-area').innerHTML = html;

            const reserveNeeded = Math.max(0, 100000 - stockCost);
            const canWithdrawTotal = totalProfit - reserveNeeded;
            const remainingWithdraw = canWithdrawTotal - totalWithdrawn;

            document.getElementById('fin-assets').innerHTML = `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border"><div class="text-xs font-black text-slate-400">ç¸½åˆ©æ½¤</div><div class="text-2xl font-black">$${totalProfit.toLocaleString()}</div></div>
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border"><div class="text-xs font-black text-indigo-400">å¯æ(æ‰£é ç•™)</div><div class="text-2xl font-black text-indigo-600">$${canWithdrawTotal.toLocaleString()}</div></div>
                <div class="bg-emerald-500 p-6 rounded-[2rem] text-white shadow-xl"><div class="text-xs font-black opacity-80">å‰©é¤˜å¯æé¤˜é¡</div><div class="text-3xl font-black">$${remainingWithdraw.toLocaleString()}</div></div>
            `;

            document.getElementById('withdraw-list').innerHTML = db.withdraws.map((w, i) => `<div class="flex justify-between bg-slate-800 p-3 rounded-xl"><span>${w.date}</span><b>$${w.amount}</b></div>`).join('');
        }

        function addWithdraw() {
            const amt = parseInt(document.getElementById('f-withdraw').value);
            if(amt > 0) {
                db.withdraws.unshift({ date: new Date().toLocaleDateString(), amount: amt });
                localStorage.setItem(KEY, JSON.stringify(db));
                renderFinance();
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(db, null, 2)], {type: "application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `YUCHILL_BACKUP.json`;
            a.click();
        }

        let html5QrCode = null;

        async function handleBarcodeScan() {
            const wrapper = document.getElementById('qr-reader-wrapper');
            wrapper.style.display = 'flex';
            html5QrCode = new Html5Qrcode("reader");
            
            try {
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: { width: 280, height: 180 } },
                    (decodedText) => {
                        document.getElementById('f-barcode').value = decodedText.toUpperCase();
                        handleBarcodeInput(decodedText);
                        stopScan();
                    },
                    (err) => {}
                );
            } catch (err) {
                console.error("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", err);
                document.getElementById('barcodeFileInput').click();
                wrapper.style.display = 'none';
            }
        }

        function stopScan() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('qr-reader-wrapper').style.display = 'none';
                });
            } else {
                document.getElementById('qr-reader-wrapper').style.display = 'none';
            }
        }

        document.getElementById('barcodeFileInput').onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const html5QrCodeStatic = new Html5Qrcode("reader");
            html5QrCodeStatic.scanFile(file, true)
                .then(decodedText => {
                    document.getElementById('f-barcode').value = decodedText.toUpperCase();
                    handleBarcodeInput(decodedText);
                })
                .catch(err => alert("ç„¡æ³•è¾¨è­˜ç…§ç‰‡ä¸­çš„æ¢ç¢¼"));
        };

        document.getElementById('f-date').valueAsDate = new Date();
        render();

        function clearAllData() {
    if (confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ­·å²ç´€éŒ„èˆ‡åº«å­˜è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
        // 1. æ¸…é™¤æ‰€æœ‰çš„ localStorage ç´€éŒ„
        localStorage.clear();
        
        // 2. æ¸…é™¤ Service Worker çš„å¿«å– (è®“ç¨‹å¼æ›´æ–°åˆ°æœ€æ–°ç‰ˆ)
        if ('caches' in window) {
            caches.keys().then(names => {
                for (let name of names) caches.delete(name);
            });
        }
        
        alert("è³‡æ–™å·²æˆåŠŸæ¸…é™¤ï¼ç¨‹å¼å°‡è‡ªå‹•é‡æ–°æ•´ç†ã€‚");
        location.reload(); // é‡æ–°æ•´ç†é é¢
    }
}
    </script>
</body>
</html>
